- name: Delete VMs
  community.general.proxmox_kvm:
    api_host: "{{ api_host }}"
    api_user: "{{ api_user }}"
    api_password: "{{ api_password }}"
    node: "{{ item.node }}"
    vmid: "{{ item.vmid }}"
    state: absent
    force: true
  with_items: "{{ ubuntu_vms }}"

- name: Create Ubuntu VMs
  community.general.proxmox_kvm:
    api_host: "{{ api_host }}"
    api_user: "{{ api_user }}"
    api_password: "{{ api_password }}"
    node: "{{ item.node }}"
    vmid: "{{ item.vmid }}"
    name: "{{ item.name }}"
    state: present
    cores: 2
    memory: 4096
    scsihw: virtio-scsi-pci
    ide:
      ide2: "local-lvm:cloudinit"
    scsi:
      scsi0: "local-zfs:0,import-from=/var/lib/vz/template/iso/noble-server-cloudimg-amd64.img"
    net:
      net0: "virtio,bridge=vmbr0"
      net1: "virtio,bridge=vmbr2"
    ipconfig:
      ipconfig0: "ip={{ item.ip }}/24,gw=192.168.5.1"
      ipconfig1: "ip=192.168.{{ subnet_third_octet }}.1/24"
    ciuser: ubuntu
    sshkeys: "{{ lookup('file', '../../.ssh/id_rsa.pub') }}"
  with_items: "{{ ubuntu_vms }}"

- name: Resize disk
  community.proxmox.proxmox_disk:
    api_host: "{{ api_host }}"
    api_user: "{{ api_user }}"
    api_password: "{{ api_password }}"
    vmid: "{{ item.vmid }}"
    disk: scsi0
    size: +20G
    state: resized
  with_items: "{{ ubuntu_vms }}"

- name: Start VMs
  community.proxmox.proxmox_kvm:
    api_host: "{{ api_host }}"
    api_user: "{{ api_user }}"
    api_password: "{{ api_password }}"
    vmid: "{{ item.vmid }}"
    state: started
  with_items: "{{ ubuntu_vms }}"
