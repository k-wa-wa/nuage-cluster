# 自宅サーバー・マルチテナント環境 構築要件定義書

## 1. 概要

本プロジェクトは、Proxmox VEおよびSDN（BGP EVPN）を活用し、少数のユーザーに対してパブリッククラウドに準ずる独立したコンピューティング環境を提供するものである。管理者がリソースを払い出し、ユーザーはCloudflare Tunnel経由で安全にアクセスする構成とする。

## 2. 物理ネットワーク構成 (Physical Layer)

物理NICを役割ごとに3系統に分離し、物理層でのセキュリティと帯域の独立性を確保する。

| 項目 | 識別 | 接続先・物理構成 | 役割・用途 |
| --- | --- | --- | --- |
| **NIC 1** | **管理/個人** | 自宅管理用セグメント | Proxmox管理(GUI/SSH)、PBS連携、管理者専用の完全隔離環境。 |
| **NIC 2** | **ユーザー内部** | SDNアンダーレイ専用SW | EVPN/VXLANトラフィック専用。ユーザー環境間のEast-West通信。 |
| **NIC 3** | **ユーザー外部** | メインルーター(VLAN) | インターネット出口(North-South通信)。Cloudflare Tunnelの通信経路。 |

## 3. 論理ネットワーク設計 (SDN Layer)

Proxmox SDNを用いた高度な分離とスケーラビリティを実現する。

### 3.1 ネットワーク分離

* **Zoneによる完全分離:** ユーザーごとに専用の **Zone** を作成し、ネットワークポリシーの境界を明確化する（VNet単位ではなくZone単位でのテナント分離）。
* **VNetの払い出し:** 各Zone内で必要に応じてVNetを払い出すが、テナント間の分離はZoneレベルで担保する。
* **プライベート空間の確保:** 管理者専用環境は別Zoneまたは物理的に分離されたネットワークとし、相互接続を制御する。

### 3.2 IPアドレス管理 (IPAM)

* **Cloud-initによる統制:** VM作成時にCloud-initを用いて、管理者が計画したIPアドレスを自動的に設定する。
* **内部ドメイン:** Technitium DNS等を用い、内部ネットワーク限定の名前解決環境（*.lab.internal等）を提供する。

## 4. サービスデリバリー要件

ユーザーに対し、パブリッククラウド的なマネージドサービス機能を共通基盤として提供する。

### 4.1 外部接続 (Connectivity)

* **Inbound (外部公開):** Cloudflare Tunnelを用い、各User Zone内の専用VM/コンテナから安全に公開する。
* **Outbound (インターネット接続):** 各Zoneに配置した **Exit Node (Gateway VM)** を経由し、NAT(Masquerade)を行ってインターネットへアクセスする。ホストのデフォルトゲートウェイ(NIC 3)を利用する。
* **ゼロトラストアクセス:** 原則として自宅ルーターのポート開放は行わず、Cloudflare Zero Trustによる認証・認可を経由したアクセスとする。

### 4.2 共通リソース (Shared Services)

**要件:**
* 共有サービス専用の **Shared Services Zone** を構築する。
* コンポーネント: DNS (Technitium/Bind), S3互換ストレージ (MinIO), DB (Postgres) 等。
* **接続方式 (ロードマップ):**
    *   **フェーズ1 (Hub & Spoke / Transit Gateway):** 全てのZoneが接続されるGateway VM / Firewallを用意し、ポリシーベースでShared Serviceへの通信を許可する。
    *   **フェーズ2 (Route Leaking):** 将来的にはBGP EVPNのRoute Leaking (VRF Leaking) を検証し、L3レベルでのダイレクトルーティングに移行する。

* **オブジェクトストレージ:** MinIOによるS3互換環境を提供。
* **データベース:** Postgresを共通基盤として運用。

## 5. セキュリティ・運用管理

### 5.1 ファイアウォールと権限管理

* **ホストレベルの保護:** Proxmoxのホストファイアウォール機能を活用し、VNet間および管理セグメントへの通信を厳格に遮断（Default Drop）する。
* **ユーザー権限 (フェーズ1):**
    *   当面の間、Proxmox GUIへのアクセス権限は付与しない。
    *   リソースの作成・変更（スペック変更、ディスク拡張等）は管理者がチケットベースで代行する。
    *   OS内部の操作（再起動、シャットダウン、ログ確認）は、ユーザー自身がSSH/コンソール経由で行う（OSのroot権限等は付与）。
    *   **将来展望:** 運用が安定した段階で、Proxmoxの「PVEVMUser」相当の限定的な閲覧・電源操作権限の付与を検討する。

### 5.2 データ保護と可用性

* **ストレージ戦略:**
    *   ネットワーク帯域（1Gbps）の制約により、Ceph等の分散ストレージは採用しない。
    *   **ローカルZFS + レプリケーション:** 各コンピュートノードのローカルZFSストレージを使用し、ProxmoxのZFS Replication機能（最短1分間隔等）を用いてノード間でデータを同期する。
    *   HA機能による自動復旧は、この同期ラグ（RPO）を許容できる範囲で設定、または手動でのフェイルオーバーを基本とする。
* **バックアップ:** Proxmox Backup Server (PBS) を導入し、NIC 1経由で高速な増分バックアップを実施する。
* **可用性の担保:** **最低3ノード** で運用し、上記レプリケーション構成によりハードウェア障害時のダウンタイムを最小化する。
